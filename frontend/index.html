<!DOCTYPE html>
<html>
<head>
    <title>Medical Price Comparator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .search-section { margin-bottom: 30px; }
        .upload-section { margin-bottom: 30px; padding: 20px; border: 2px dashed #ccc; }
        .results-section { margin-top: 30px; }
        input, button { padding: 10px; margin: 5px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .price-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .price-table th, .price-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .price-table th { background-color: #f2f2f2; position: sticky; top: 0; }
        .loading { display: none; text-align: center; }
        .admin-link { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: #28a745; 
            color: white; 
            padding: 8px 15px; 
            text-decoration: none; 
            border-radius: 4px; 
        }
        .admin-link:hover { background: #218838; }
    </style>
</head>
<body>
    <a href="/admin.html" class="admin-link">Admin Panel</a>
    
    <div class="container">
        <div class="header">
            <h1>üè• Medical Price Comparator</h1>
            <p>Compare medical analysis prices across Romanian healthcare providers</p>
        </div>
        
        <div class="upload-section">
            <h3>üìã Upload Doctor's Recommendation (OCR)</h3>
            <input type="file" id="imageFile" accept="image/*">
            <button onclick="processOCR()">Process with AI</button>
            <div id="ocrLoading" class="loading">Processing image...</div>
        </div>
        
        <div class="search-section">
            <h3>üîç Search Analyses</h3>
            <input type="text" id="searchInput" placeholder="Enter analysis names (comma separated)" style="width: 70%;">
            <button onclick="searchAnalyses()">Search Prices</button>
            <div id="searchLoading" class="loading">Searching...</div>
        </div>
        
        <div class="results-section">
            <div id="results"></div>
        </div>
    </div>
    
    <script>
        // Configuration
        const API_BASE_URL = '/api/v1';
        
        async function processOCR() {
            const fileInput = document.getElementById('imageFile');
            const loading = document.getElementById('ocrLoading');
            
            if (!fileInput.files[0]) {
                alert('Please select an image file');
                return;
            }
            
            loading.style.display = 'block';
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            
            try {
                const response = await fetch(`${API_BASE_URL}/ocr/process`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.analyses && result.analyses.length > 0) {
                    document.getElementById('searchInput').value = result.analyses.join(', ');
                    await searchAnalyses();
                } else {
                    alert('No analyses detected in the image');
                }
            } catch (error) {
                alert('Error processing image: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        async function searchAnalyses() {
            const searchInput = document.getElementById('searchInput');
            const loading = document.getElementById('searchLoading');
            const results = document.getElementById('results');
            
            if (!searchInput.value.trim()) {
                alert('Please enter analysis names');
                return;
            }
            
            loading.style.display = 'block';
            
            const analyses = searchInput.value.split(',').map(s => s.trim()).filter(s => s);
            
            try {
                const response = await fetch(`${API_BASE_URL}/analyses/compare`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        analysis_names: analyses
                    })
                });
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                results.innerHTML = '<p>Error searching analyses: ' + error.message + '</p>';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function displayResults(data) {
            const results = document.getElementById('results');
            
            if (!data.results || data.results.length === 0) {
                results.innerHTML = '<p>No results found for the specified analyses.</p>';
                return;
            }
            
            let html = '<h3>üí∞ Price Comparison Results</h3>';
            html += '<table class="price-table">';
            html += '<thead><tr><th>Analysis</th>';
            
            // Get all unique providers
            const providers = new Set();
            data.results.forEach(analysis => {
                Object.keys(analysis.prices || {}).forEach(provider => {
                    providers.add(provider);
                });
            });
            
            Array.from(providers).forEach(provider => {
                html += `<th>${provider.charAt(0).toUpperCase() + provider.slice(1)}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            data.results.forEach(analysis => {
                html += `<tr><td><strong>${analysis.name}</strong>`;
                if (analysis.alternative_names && analysis.alternative_names.length > 0) {
                    html += `<br><small>(${analysis.alternative_names.join(', ')})</small>`;
                }
                html += '</td>';
                
                Array.from(providers).forEach(provider => {
                    const providerPrices = analysis.prices && analysis.prices[provider];
                    html += '<td>';
                    
                    if (providerPrices) {
                        if (providerPrices.normal) {
                            html += `Normal: ${providerPrices.normal.amount} ${providerPrices.normal.currency}<br>`;
                        }
                        if (providerPrices.premium) {
                            html += `Premium: ${providerPrices.premium.amount} ${providerPrices.premium.currency}<br>`;
                        }
                        if (providerPrices.subscription) {
                            html += `Subscription: ${providerPrices.subscription.amount} ${providerPrices.subscription.currency}`;
                        }
                    } else {
                        html += 'N/A';
                    }
                    
                    html += '</td>';
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            results.innerHTML = html;
        }
    </script>
</body>
</html>